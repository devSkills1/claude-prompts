# Flutter 代码审查与回滚

> 代码改动的审查流程和回滚策略

---

## 【使用场景】

在以下情况使用此模板：
- 每个步骤执行完成后
- 合并代码到主分支前
- 发现问题需要回滚时
- 定期代码审查时

---

## 【审查输入】

```markdown
【审查信息】
- 关联 Plan 文档：plan_xxx.md
- 执行步骤编号：X.X
- 变更描述：（简述改动）
- 变更 diff：（git diff 输出或文件列表）
- 测试结果：（编译/测试是否通过）
```

---

## 【请输出】

### 1. 审查检查清单

#### P0 阻断项（必须通过）

**代码质量：**
- [ ] 是否改变了 public API 签名
- [ ] 是否引入已知性能问题
- [ ] 是否引入内存泄漏风险
- [ ] 是否可在 5 分钟内回滚
- [ ] 是否通过编译和基础测试

**功能完整性：**
- [ ] 是否完整实现计划功能
- [ ] 边界情况是否处理
- [ ] 错误处理是否完善

**兼容性：**
- [ ] 是否影响现有功能
- [ ] 是否兼容目标 Flutter 版本
- [ ] 是否在目标平台测试（iOS/Android）

---

#### P1 必须说明

**实现偏离：**
- [ ] 是否偏离原 Plan 目标？
  - 如是：说明原因和新方案合理性

**技术债务：**
- [ ] 是否引入临时兼容代码？
  - 如是：说明清理计划

**稳定性：**
- [ ] 是否存在潜在崩溃风险？
  - 如是：说明验证方式

**性能影响：**
- [ ] 是否影响性能指标？
  - 如是：说明具体影响和可接受性

---

#### P2 建议项

**代码优化：**
- [ ] 是否应进一步优化
- [ ] 是否有重复代码可提取

**测试覆盖：**
- [ ] 是否需要补充单元测试
- [ ] 是否需要 Widget 测试

**文档完善：**
- [ ] 是否需要补充代码注释
- [ ] 是否需要更新文档

---

### 2. 安全审计

**资源释放：**
- [ ] StreamController 是否正确关闭
- [ ] 监听器是否正确移除
- [ ] AnimationController 是否 dispose
- [ ] Timer 是否取消

**异步处理：**
- [ ] 异常是否正确捕获
- [ ] Future/Stream 是否处理错误
- [ ] 是否有未处理的 unawaited future

**状态管理：**
- [ ] 状态更新是否线程安全
- [ ] 是否避免状态直接修改（不可变）

---

### 3. 性能审查

**渲染性能：**
- [ ] Widget 树是否合理
- [ ] 是否有不必要的 rebuild
- [ ] 是否使用 const 构造函数

**内存使用：**
- [ ] 是否有内存泄漏风险
- [ ] 大对象是否及时释放
- [ ] 图片缓存是否合理

**启动影响：**
- [ ] 是否增加启动时间
- [ ] 如增加，是否可接受

---

### 4. 平台兼容性

**iOS：**
- [ ] 是否在真机测试
- [ ] SafeArea 是否正确
- [ ] 键盘处理是否正常

**Android：**
- [ ] 是否在真机测试
- [ ] 返回键是否正确处理
- [ ] 权限请求是否正常

**Web/Desktop（如适用）：**
- [ ] 是否测试目标平台

---

### 5. 回滚策略

#### 回滚方案

**Git 回滚：**
```bash
# 方式 1：Revert commit
git revert <commit_hash>

# 方式 2：Reset 到之前的提交（慎用）
git reset --hard <previous_commit>

# 方式 3：创建回滚分支
git checkout -b rollback/xxx
git revert <commit_hash>
```

**回滚影响评估：**
- 是否影响已发布功能：是/否
- 是否需要数据迁移回滚：是/否
- 预计回滚耗时：< X 分钟
- 回滚风险：低/中/高

---

#### 回滚验证

回滚后必须验证：
- [ ] 核心功能正常（用户登录/主要流程）
- [ ] 性能指标正常
- [ ] 无新增崩溃
- [ ] 回归测试通过

---

### 6. 改进建议

**代码层面：**
1. 建议 1：...
2. 建议 2：...

**测试层面：**
1. 建议 1：...
2. 建议 2：...

**文档层面：**
1. 建议 1：...

---

### 7. 审查结论

**审查人：** （姓名/AI Assistant）

**审查时间：** YYYY-MM-DD HH:mm

**结论：**
- ✅ 通过 - 可合并
- ⚠️ 有条件通过 - 需小幅调整后合并
- ❌ 不通过 - 需重大修改

**通过条件（如有条件通过）：**
1. 条件 1：...
2. 条件 2：...

**阻断问题（如不通过）：**
1. 问题 1：...
   - 严重程度：P0
   - 修复建议：...

**下一步行动：**
1. 行动 1
2. 行动 2

---

## 【审查示例】

### 示例 1：State Provider 审查

**输入：**
```
【审查信息】
- 关联 Plan：plan_state_management.md
- 步骤：3.1 - 创建 UserProvider
- 变更：新增 lib/providers/user_provider.dart
- 测试：编译通过，手动测试通过
```

**输出：**
```
## 审查检查清单

### P0 阻断项
✅ 未改变 public API
✅ 无已知性能问题
✅ 无内存泄漏风险
✅ 可快速回滚（新增文件）
✅ 编译和测试通过

### P1 必须说明
✅ 是否偏离原 Plan？
   否，严格按照 Plan 3.1 实施

✅ 是否引入临时兼容代码？
   否

✅ 是否存在稳定性隐患？
   否，已测试基本功能

✅ 是否影响性能？
   否，仅新增代码，不影响现有性能

### P2 建议项
⚠️ 是否应进一步优化
   建议：添加单元测试

## 安全审计
✅ 无需释放资源（ChangeNotifier 由框架管理）
✅ 无异步操作
✅ 状态更新正确使用 notifyListeners

## 性能审查
✅ 代码简洁，无性能问题

## 回滚策略
- 回滚方式：删除文件即可
- 回滚耗时：< 1 分钟
- 回滚风险：低（新增文件，无依赖）

## 审查结论
**结论：** ✅ 通过

**建议：**
- 补充单元测试
- 继续执行下一步（3.2）
```

---

## 【紧急回滚流程】

如发现严重问题需要紧急回滚：

### Step 1：评估影响
- 问题严重程度：P0/P1/P2
- 影响范围：全部用户/部分用户/开发环境
- 是否需要立即回滚：是/否

### Step 2：执行回滚
```bash
# 1. 创建回滚分支
git checkout -b hotfix/rollback-xxx

# 2. Revert 问题提交
git revert <commit_hash>

# 3. 验证回滚
flutter test
flutter run

# 4. 提交回滚
git push origin hotfix/rollback-xxx
```

### Step 3：验证修复
- [ ] 核心功能正常
- [ ] 性能正常
- [ ] 无新增崩溃

### Step 4：问题复盘
- 问题原因：...
- 如何避免：...
- 改进措施：...

---

## 【总结】

**审查的目的：**
- 确保代码质量
- 及时发现问题
- 降低上线风险
- 保证可回滚性

**原则：**
- 宁可多审查，不可少审查
- 发现问题立即说明
- 回滚要果断，不要犹豫
- 每次审查都是学习机会
