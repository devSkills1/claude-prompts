# Flutter 性能优化规划

> 本模板用于分析 Flutter 应用性能问题并给出优化方案

---

## 【使用说明】

**目的：** 输出结构化的性能分析和优化方案，不直接写代码。

**适用场景：**
- 页面卡顿/掉帧
- 启动速度慢
- 内存泄漏/占用过高
- 包体积过大
- 网络请求优化
- 渲染性能问题

---

## 【背景】

### 项目基本信息
- **Flutter 版本：** （如 3.16.0）
- **Dart 版本：** （如 3.2.0）
- **平台：** （iOS/Android/Web/Desktop）
- **设备范围：** （目标设备性能范围）

### 性能问题描述
- **问题类型：** （卡顿/内存/启动/包体积/网络/其他）
- **出现场景：** （具体页面或操作）
- **复现路径：** （如何稳定复现）
- **影响范围：** （所有用户/特定设备/特定版本）

### 性能指标
- **当前表现：**
  - 帧率：XXX fps（目标 60fps）
  - 启动时间：XXX ms
  - 内存占用：XXX MB
  - 包体积：XXX MB
  - 网络请求耗时：XXX ms

- **目标要求：**
  - 帧率：≥ 60fps
  - 启动时间：< XXX ms
  - 内存占用：< XXX MB
  - 包体积：< XXX MB

### 约束条件
- **现有依赖：** （已使用的包和框架）
- **技术债务：** （已知的性能问题）
- **资源限制：** （人力/时间）

---

## 【请输出】

### 1. 性能问题诊断

**1.1 渲染性能分析**

**帧率检测：**
- 是否存在掉帧：
- 掉帧场景：
- 可疑原因：

**常见渲染问题排查：**
- [ ] Widget 树过深（是否超过 10 层）
- [ ] 不必要的 rebuild（是否滥用 setState）
- [ ] 大量同步计算（是否在 build 中执行重计算）
- [ ] 图片加载问题（是否未缓存/尺寸过大）
- [ ] 动画实现不当（是否使用隐式动画导致全局重建）

**1.2 内存问题分析**

**内存泄漏检测：**
- 监听器未释放：
- 定时器未取消：
- Stream 未关闭：
- 大对象未释放：

**内存占用过高：**
- 图片缓存策略：
- 数据缓存大小：
- 第三方包内存占用：

**1.3 启动性能分析**

**启动耗时分解：**
- 原生启动耗时：XXX ms
- Dart VM 初始化：XXX ms
- 首帧渲染：XXX ms
- 总耗时：XXX ms

**启动优化空间：**
- [ ] 减少启动依赖
- [ ] 延迟初始化
- [ ] 启动页优化

**1.4 包体积分析**

**包体积分解：**
- APK/IPA 总大小：XXX MB
- 代码大小：XXX MB
- 资源大小：XXX MB
- 三方库大小：XXX MB

**体积优化空间：**
- [ ] 图片资源优化
- [ ] 字体文件优化
- [ ] 依赖包精简
- [ ] 代码混淆压缩

---

### 2. 优化方案

**2.1 渲染优化**

**Widget 优化：**
```
优化项 1：减少 Widget 树深度
- 当前问题：...
- 优化方案：...
- 预期收益：...

优化项 2：使用 const 构造函数
- 适用场景：...
- 实施建议：...
- 预期收益：...

优化项 3：拆分 Widget
- 拆分策略：...
- 注意事项：...
- 预期收益：...
```

**重建优化：**
- 使用 ValueListenableBuilder
- 使用 Selector（Provider）
- 合理使用 RepaintBoundary
- 避免在 build 中创建新对象

**列表优化：**
- 使用 ListView.builder
- 实现懒加载
- 图片预加载
- 滚动性能优化

**2.2 内存优化**

**资源释放：**
```dart
// 监听器释放模式
@override
void dispose() {
  // 取消监听
  // 关闭 Stream
  // 停止定时器
  super.dispose();
}
```

**图片优化：**
- 使用合适的图片格式（WebP）
- 图片缓存策略
- 图片尺寸适配
- 预加载和清理

**数据缓存：**
- LRU 缓存策略
- 内存阈值控制
- 及时清理过期数据

**2.3 启动优化**

**延迟初始化：**
- 非关键服务延迟加载
- 首屏数据懒加载
- 预热关键页面

**启动流程优化：**
1. 减少启动依赖初始化
2. 异步初始化非关键服务
3. 优化首屏渲染路径

**2.4 包体积优化**

**资源优化：**
- 图片压缩（WebP/AVIF）
- 字体裁剪
- 资源按需加载

**代码优化：**
- 移除无用代码
- 代码分割
- Tree shaking

**依赖优化：**
- 精简三方包
- 使用轻量级替代方案

---

### 3. 工具和监控

**性能分析工具：**
- Flutter DevTools（Performance/Memory）
- Observatory
- ADB logcat（Android）
- Xcode Instruments（iOS）

**监控指标：**
- FPS 监控
- 内存监控
- 启动时间监控
- 网络请求监控

**持续监控方案：**
- 集成性能监控 SDK（如 Firebase Performance）
- 建立性能基线
- 自动化性能测试

---

### 4. 优先级排序

**P0 - 必须立即解决：**
1. 问题 1：...
   - 影响：...
   - 方案：...
   - 预期收益：...

**P1 - 重要但不紧急：**
1. 问题 1：...
   - 影响：...
   - 方案：...
   - 预期收益：...

**P2 - 优化项：**
1. 问题 1：...
   - 影响：...
   - 方案：...
   - 预期收益：...

---

### 5. 实施计划

**阶段 1：性能分析（X 天）**
- [ ] 使用 DevTools 分析
- [ ] 定位性能瓶颈
- [ ] 确认优化方向

**阶段 2：优化实施（X 周）**
- [ ] P0 问题修复
- [ ] P1 问题优化
- [ ] P2 优化项

**阶段 3：验证监控（X 天）**
- [ ] 性能测试
- [ ] 灰度验证
- [ ] 数据对比

**阶段 4：持续优化**
- [ ] 建立性能监控
- [ ] 定期性能审查

---

### 6. 风险评估

**技术风险：**
- 风险 1：大规模重构可能引入新问题
  - 缓解措施：分步实施，充分测试

**业务风险：**
- 风险 1：优化耗时影响迭代
  - 缓解措施：合理排期，优先解决 P0

---

### 7. 效果评估

**量化指标：**
- 帧率提升：XX fps → XX fps
- 内存降低：XX MB → XX MB
- 启动加速：XX ms → XX ms
- 包体积减小：XX MB → XX MB

**用户体验：**
- 操作流畅度提升
- 崩溃率降低
- 用户留存提升

---

### 8. 最佳实践总结

**开发规范：**
1. Widget 设计原则
2. 状态管理规范
3. 资源使用规范
4. 性能测试要求

**Code Review 检查点：**
- [ ] 是否有性能隐患
- [ ] 是否正确释放资源
- [ ] 是否使用性能最佳实践

---

## 【输出要求】

1. **数据支撑：** 使用 DevTools 等工具获取真实数据
2. **具体方案：** 每个优化项都要有具体实施方案
3. **量化目标：** 明确优化前后的量化指标
4. **风险控制：** 评估优化风险和应对措施

---

## 【注意事项】

⚠️ **本模板仅做分析规划，不直接生成代码**

✅ **后续步骤：**
1. 使用 DevTools 分析定位问题
2. 将输出作为优化方案文档
3. 使用 `code_execute_step.md` 逐步优化
4. 使用 `checklist.md` 验证优化效果
5. 持续监控性能指标
