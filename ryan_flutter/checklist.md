# Flutter 开发审计检查清单

> 发布前/Code Review 时的完整检查清单

---

## 使用说明

**用途：** 在以下场景使用此清单
- 重要功能发布前
- Code Review 时
- 性能优化后验证
- 定期代码审计

**使用方式：**
1. 逐项检查，标记 `[x]` 表示通过
2. 发现问题记录并修复
3. 全部通过后方可发布

---

## 1. 性能检查

### 1.1 渲染性能

**P0 - 必须检查：**
- [ ] 帧率是否稳定在 60fps（使用 Performance Overlay）
- [ ] 是否存在明显卡顿（列表滚动、动画播放）
- [ ] Widget 树深度是否合理（单条路径 < 15 层）
- [ ] 是否滥用 setState 导致不必要的重建
- [ ] 是否使用 const 构造函数优化静态 Widget

**P1 - 建议检查：**
- [ ] 是否合理使用 RepaintBoundary
- [ ] 是否使用 ListView.builder 处理长列表
- [ ] 是否避免在 build 方法中进行重计算
- [ ] 是否使用 Selector/Consumer 精确订阅状态

**检查工具：**
- Flutter DevTools - Performance
- `flutter run --profile` 模式测试

---

### 1.2 内存管理

**P0 - 必须检查：**
- [ ] 所有 StreamController 是否在 dispose 中关闭
- [ ] 所有监听器（Listener）是否正确移除
- [ ] 所有 AnimationController 是否 dispose
- [ ] 定时器（Timer）是否取消
- [ ] 图片缓存是否有大小限制

**P1 - 建议检查：**
- [ ] 大对象是否及时释放
- [ ] 是否存在循环引用
- [ ] 内存占用是否在合理范围（< 200MB）

**检查工具：**
- Flutter DevTools - Memory
- Android Studio Memory Profiler

---

### 1.3 启动性能

**P0 - 必须检查：**
- [ ] 冷启动时间 < 3 秒（中低端设备）
- [ ] 首屏渲染是否快速（< 1 秒）
- [ ] 是否有不必要的同步初始化

**P1 - 建议检查：**
- [ ] 非关键服务是否延迟初始化
- [ ] 启动页是否使用原生实现

**检查方式：**
```bash
# Android
adb logcat | grep "ActivityManager"

# iOS
在 Xcode 中查看 Time Profiler
```

---

## 2. 代码质量

### 2.1 Widget 设计

**P0 - 必须检查：**
- [ ] Widget 是否职责单一（不超过 200 行）
- [ ] 是否正确区分 StatelessWidget 和 StatefulWidget
- [ ] 是否避免 Widget 内部存储业务逻辑
- [ ] 是否使用 Key 管理 Widget 状态（必要时）

**P1 - 建议检查：**
- [ ] 是否抽取可复用的组件
- [ ] 是否使用 Builder Pattern 简化复杂 Widget
- [ ] 是否有适当的注释说明复杂逻辑

---

### 2.2 状态管理

**P0 - 必须检查：**
- [ ] 状态是否合理分层（全局/页面/组件）
- [ ] 是否避免全局状态滥用
- [ ] 状态更新是否遵循不可变原则
- [ ] 是否正确处理异步状态（loading/error）

**P1 - 建议检查：**
- [ ] 是否使用统一的状态管理方案
- [ ] 是否有状态持久化需求（SharedPreferences/Hive）
- [ ] 是否有状态恢复逻辑（App 后台恢复）

---

### 2.3 异步处理

**P0 - 必须检查：**
- [ ] 所有 async 方法是否正确处理异常
- [ ] 是否避免 async 死锁
- [ ] 长时间操作是否使用 Isolate
- [ ] 网络请求是否有超时设置
- [ ] 是否取消未完成的异步操作（页面销毁时）

**P1 - 建议检查：**
- [ ] 是否使用 FutureBuilder/StreamBuilder 管理异步 UI
- [ ] 是否实现错误重试机制
- [ ] 是否有防抖/节流处理

---

### 2.4 API 使用规范

**P0 - 必须检查：**
- [ ] **是否使用已废弃 (deprecated) 的 API**
  - 检查 Dart Analysis Warnings 中的 deprecated 提示
  - 必须替换为官方推荐的新 API
  - 使用 `flutter doctor` 检查 SDK 版本兼容性
- [ ] 是否使用了未来版本才支持的 API（检查 pubspec.yaml SDK 约束）
- [ ] 第三方包是否使用最新稳定版本

**P1 - 建议检查：**
- [ ] 是否有更现代的替代 API（如 Navigator 2.0）
- [ ] 是否遵循 Dart 3.x null safety 规范

**常见废弃 API 替换示例：**

```dart
// ❌ 废弃：Scaffold.of(context)
final scaffold = Scaffold.of(context);

// ✅ 推荐：ScaffoldMessenger
ScaffoldMessenger.of(context).showSnackBar(
  SnackBar(content: Text('消息'))
);

// ❌ 废弃：FlatButton / RaisedButton
FlatButton(onPressed: () {}, child: Text('按钮'))

// ✅ 推荐：TextButton / ElevatedButton
TextButton(onPressed: () {}, child: Text('按钮'))
```

---

## 3. 平台兼容性

### 3.1 iOS 兼容性

**P0 - 必须检查：**
- [ ] 在真机上测试（至少 iOS 13+）
- [ ] 安全区域是否正确处理（SafeArea）
- [ ] 键盘弹出是否影响布局
- [ ] 是否适配不同屏幕尺寸（iPhone SE 到 Pro Max）

**P1 - 建议检查：**
- [ ] 暗黑模式是否正常显示
- [ ] 横屏是否支持（如需要）
- [ ] 是否处理系统返回手势

---

### 3.2 Android 兼容性

**P0 - 必须检查：**
- [ ] 在真机上测试（至少 Android 5.0+）
- [ ] 不同屏幕密度是否正常显示
- [ ] 返回键是否正确处理
- [ ] 权限请求是否正常（相机/存储等）

**P1 - 建议检查：**
- [ ] 是否适配异形屏
- [ ] 是否处理多任务切换
- [ ] 是否测试低端设备性能

---

### 3.3 Web/Desktop（如适用）

**P0 - 必须检查：**
- [ ] 响应式布局是否正常
- [ ] 鼠标/键盘交互是否正常
- [ ] URL 路由是否正确

---

## 4. 资源管理

### 4.1 图片资源

**P0 - 必须检查：**
- [ ] 图片是否使用合适的格式（WebP 优先）
- [ ] 图片尺寸是否过大（避免 > 1MB 的图片）
- [ ] 是否提供多种分辨率（1x/2x/3x）
- [ ] 是否使用 CachedNetworkImage 缓存网络图片

**P1 - 建议检查：**
- [ ] 图片是否懒加载
- [ ] 是否实现图片预加载（关键图片）
- [ ] 是否清理不再使用的图片缓存

---

### 4.2 字体和本地化

**P0 - 必须检查：**
- [ ] 自定义字体是否正确加载
- [ ] 文本是否支持多语言（如需要）
- [ ] 是否处理文本溢出（overflow）

---

## 5. 网络和数据

### 5.1 网络请求

**P0 - 必须检查：**
- [ ] 是否正确处理网络错误（超时/无网络/服务器错误）
- [ ] 是否显示加载状态（Loading）
- [ ] 是否有请求取消机制（页面退出时）
- [ ] 敏感数据是否使用 HTTPS

**P1 - 建议检查：**
- [ ] 是否实现请求缓存
- [ ] 是否有请求重试机制
- [ ] 是否记录网络请求日志（开发环境）

---

### 5.2 数据持久化

**P0 - 必须检查：**
- [ ] 本地存储是否正确初始化
- [ ] 敏感数据是否加密存储
- [ ] 是否处理存储失败情况

**P1 - 建议检查：**
- [ ] 是否有数据迁移方案（版本升级）
- [ ] 是否定期清理过期数据

---

## 6. 用户体验

### 6.1 交互反馈

**P0 - 必须检查：**
- [ ] 按钮点击是否有视觉反馈
- [ ] 加载状态是否明确展示
- [ ] 错误信息是否友好易懂
- [ ] 是否处理双击/多次点击

**P1 - 建议检查：**
- [ ] 是否有空状态提示
- [ ] 是否有骨架屏（Skeleton）
- [ ] 动画是否流畅自然

---

### 6.2 无障碍

**P1 - 建议检查：**
- [ ] 是否支持屏幕阅读器（Semantics）
- [ ] 对比度是否足够（文字可读性）
- [ ] 按钮点击区域是否足够大（≥ 44x44）

---

## 7. 安全检查

**P0 - 必须检查：**
- [ ] API Key 是否硬编码在代码中（应使用环境变量）
- [ ] 敏感数据是否加密存储
- [ ] 是否使用 HTTPS
- [ ] 用户输入是否验证和清理

**P1 - 建议检查：**
- [ ] 是否实现证书锁定（Certificate Pinning）
- [ ] 是否混淆代码（Release 模式）
- [ ] 是否记录安全日志

---

## 8. 包体积

**P0 - 必须检查：**
- [ ] APK/IPA 大小是否在合理范围（< 50MB）
- [ ] 是否移除未使用的资源
- [ ] 是否开启代码压缩（ProGuard/R8）

**P1 - 建议检查：**
- [ ] 是否使用 Bundle（App Bundle/App Clips）
- [ ] 是否分析包体积构成（flutter build --analyze-size）

---

## 9. 测试覆盖

**P0 - 必须检查：**
- [ ] 核心功能是否有单元测试
- [ ] 是否通过集成测试

**P1 - 建议检查：**
- [ ] Widget 测试覆盖率 > 60%
- [ ] 是否有自动化 UI 测试

---

## 10. 发布准备

**P0 - 必须检查：**
- [ ] 版本号是否更新（pubspec.yaml）
- [ ] 更新日志是否准备
- [ ] 是否移除调试代码和日志
- [ ] 是否使用 Release 模式构建
- [ ] 是否在目标设备上完整测试

**P1 - 建议检查：**
- [ ] 是否准备灰度发布计划
- [ ] 是否配置崩溃监控（Crashlytics/Sentry）
- [ ] 是否准备回滚方案

---

## 审计结论模板

**审计时间：** YYYY-MM-DD

**审计范围：** （功能模块/页面）

**检查结果：**
- ✅ 通过项：XX 项
- ⚠️ 警告项：XX 项（需优化但不阻塞发布）
- ❌ 阻断项：XX 项（必须修复）

**阻断问题：**
1. 问题描述
   - 严重程度：P0
   - 修复方案：
   - 预计修复时间：

**结论：** ✅ 可发布 / ❌ 需修复后再发布

**审计人：** XXX
