# TypeScript 代码审查与回滚

> 代码改动的审查流程和回滚策略

---

## 【使用场景】

在以下情况使用此模板：
- 每个步骤执行完成后
- 合并代码到主分支前
- 发现问题需要回滚时
- 定期代码审查时

---

## 【审查输入】

```markdown
【审查信息】
- 关联 Plan 文档：plan_xxx.md
- 执行步骤编号：X.X
- 变更描述：（简述改动）
- 变更文件：（文件列表或 git diff）
- 测试结果：（tsc/lint/test 是否通过）
```

---

## 【请输出】

### 1. 审查检查清单

#### P0 阻断项（必须通过）

**类型安全：**
- [ ] tsc --noEmit 编译通过
- [ ] 无显式 any 类型（除非必要且已说明）
- [ ] 无类型断言滥用（as）
- [ ] 类型推导正确
- [ ] 泛型约束合理

**代码质量：**
- [ ] ESLint 检查通过
- [ ] 单元测试通过
- [ ] 命名规范符合项目约定
- [ ] 无循环依赖

**功能完整性：**
- [ ] 是否完整实现计划功能
- [ ] 边界情况是否处理
- [ ] 类型守卫是否正确

---

#### P1 必须说明

**实现偏离：**
- [ ] 是否偏离原 Plan 目标？
  - 如是：说明原因和新方案合理性

**类型复杂度：**
- [ ] 类型嵌套是否过深（> 5 层）？
  - 如是：说明必要性和简化方案

**性能影响：**
- [ ] 是否影响编译性能？
  - 如是：说明具体影响（编译时间增加 XX%）

**依赖变更：**
- [ ] 是否新增依赖？
  - 如是：说明必要性和替代方案

---

#### P2 建议项

**代码优化：**
- [ ] 是否应使用更精确的类型
- [ ] 是否应添加类型守卫
- [ ] 是否有重复类型可提取

**测试覆盖：**
- [ ] 是否需要补充类型测试
- [ ] 是否需要补充单元测试

**文档完善：**
- [ ] 复杂类型是否需要注释
- [ ] 公共 API 是否需要 JSDoc

---

### 2. 类型安全审查

**类型覆盖率：**
```bash
# 检查 any 使用
grep -r ": any" src/
grep -r "as any" src/

# 检查类型断言
grep -r " as " src/
```

**类型推导验证：**
- [ ] 泛型推导是否正确
- [ ] 联合类型是否正确收窄
- [ ] 返回值类型是否明确

**空值安全：**
- [ ] Optional Chaining 使用正确
- [ ] Nullish Coalescing 使用正确
- [ ] strictNullChecks 兼容

---

### 3. 性能审查

**编译性能：**
```bash
# 检查编译时间
time tsc --noEmit

# 编译诊断
tsc --extendedDiagnostics
```

**类型复杂度：**
- [ ] 类型嵌套深度 < 5 层
- [ ] 条件类型是否可简化
- [ ] 递归类型是否有终止条件

---

### 4. 可维护性审查

**类型组织：**
- [ ] 类型定义位置合理
- [ ] 共享类型已提取
- [ ] 使用 import type

**命名规范：**
- [ ] 接口/类型命名清晰
- [ ] 泛型参数命名有意义
- [ ] 枚举命名符合规范

**注释文档：**
- [ ] 复杂类型有注释
- [ ] 公共 API 有 JSDoc
- [ ] 已知限制有说明

---

### 5. 回滚策略

#### 回滚方案

**Git 回滚：**
```bash
# 方式 1：Revert commit
git revert <commit_hash>

# 方式 2：Reset 到之前的提交（慎用）
git reset --hard <previous_commit>

# 方式 3：创建回滚分支
git checkout -b rollback/xxx
git revert <commit_hash>
```

**类型回滚影响评估：**
- 是否影响已发布功能：是/否
- 是否需要类型迁移：是/否
- 预计回滚耗时：< X 分钟
- 回滚风险：低/中/高

---

#### 回滚验证

回滚后必须验证：
- [ ] tsc --noEmit 通过
- [ ] 单元测试通过
- [ ] ESLint 检查通过
- [ ] 无类型错误

---

### 6. 改进建议

**类型层面：**
1. 建议 1：使用更精确的类型...
2. 建议 2：添加类型守卫...

**性能层面：**
1. 建议 1：简化复杂类型...

**文档层面：**
1. 建议 1：补充 JSDoc 注释...

---

### 7. 审查结论

**审查人：** （姓名/AI Assistant）

**审查时间：** YYYY-MM-DD HH:mm

**TypeScript 版本：** X.X.X

**结论：**
- ✅ 通过 - 可合并
- ⚠️ 有条件通过 - 需小幅调整后合并
- ❌ 不通过 - 需重大修改

**类型检查结果：**
```bash
tsc --noEmit
# ✅ 0 errors
# ⚠️ X errors
```

**通过条件（如有条件通过）：**
1. 条件 1：补充类型注释
2. 条件 2：添加单元测试

**阻断问题（如不通过）：**
1. 问题 1：使用了 any 类型
   - 严重程度：P0
   - 修复建议：使用 unknown 或具体类型

**下一步行动：**
1. 修复阻断问题
2. 补充类型测试
3. 重新提交审查

---

## 【审查示例】

### 示例 1：API 响应类型审查

**输入：**
```
【审查信息】
- 关联 Plan：plan_types.md
- 步骤：2.1 - 定义 API 响应类型
- 变更：新增 src/types/api.ts
- 测试：tsc 通过，ESLint 通过
```

**输出：**
```
## 审查检查清单

### P0 阻断项
✅ tsc --noEmit 通过
✅ 无 any 类型
✅ 类型推导正确
✅ ESLint 通过
✅ 单元测试通过

### P1 必须说明
✅ 是否偏离原 Plan？
   否，严格按照 Plan 2.1 实施

✅ 类型复杂度
   适中，使用联合类型和泛型，清晰易懂

✅ 性能影响
   编译时间：1.2s → 1.3s（增加 8%，可接受）

### P2 建议项
⚠️ 建议添加类型测试
   - 使用 tsd 验证类型推导
   - 测试类型守卫是否正确

## 类型安全审查
✅ 无 any 使用
✅ 类型推导正确
✅ 泛型约束合理

## 性能审查
✅ 编译时间增加 < 10%
✅ 类型嵌套深度 < 5 层

## 可维护性审查
✅ 命名清晰
✅ 有 JSDoc 注释
⚠️ 建议补充使用示例

## 回滚策略
- 回滚方式：git revert
- 回滚耗时：< 1 分钟
- 回滚风险：低（新增文件，无依赖）

## 审查结论
**结论：** ⚠️ 有条件通过

**建议：**
1. 补充类型测试（tsd）
2. 添加使用示例到注释
3. 继续执行下一步（2.2）
```

---

## 【紧急回滚流程】

如发现严重问题需要紧急回滚：

### Step 1：评估影响
- 问题严重程度：P0/P1/P2
- 影响范围：全部代码/部分模块
- 是否需要立即回滚：是/否

### Step 2：执行回滚
```bash
# 1. 创建回滚分支
git checkout -b hotfix/rollback-xxx

# 2. Revert 问题提交
git revert <commit_hash>

# 3. 验证回滚
tsc --noEmit
npm test

# 4. 提交回滚
git push origin hotfix/rollback-xxx
```

### Step 3：验证修复
- [ ] tsc --noEmit 通过
- [ ] 单元测试通过
- [ ] ESLint 通过
- [ ] 无新增类型错误

### Step 4：问题复盘
- 问题原因：...
- 如何避免：...
- 改进措施：...

---

## 【总结】

**审查的目的：**
- 确保类型安全
- 及时发现问题
- 降低上线风险
- 保证可回滚性

**原则：**
- 类型安全优先
- 无 any 容忍
- 编译必须通过
- 可维护性第一
