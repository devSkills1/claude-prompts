# iOS 安全加固 / 反逆向 / 反调试

> 参考 checklist.md 中的安全审计清单

【背景】
- 安全阶段（开发 / 已上线）：
- 当前已有检测手段：
- App 类型（金融 / 社交 / 工具）：
- 安全等级要求（高 / 中 / 低）：

【攻击模型】（完整覆盖）

## P0（必须防护）
- **越狱检测**：Cydia/Sileo 检测、文件系统检测、沙盒完整性
- **调试检测**：lldb / ptrace / sysctl / task_info
- **重签名/篡改**：CodeSignature / Bundle ID / Team ID / embedded.mobileprovision
- **注入检测**：dylib / frida / Cycript / _dyld_image_count()

## P1（建议防护）
- **Hook 检测**：fishhook / Method Swizzle / Substrate / Dobby
- **中间人攻击**：SSL Pinning / 证书固定
- **模拟器检测**：iOS Simulator / Corellium
  - **注意：金融/支付类应用建议提升至 P0**
  - 模拟器环境无 Secure Enclave，Keychain 保护降级
- **内存篡改**：运行时内存修改（GameGuardian / iGameGod）

## P2（可选防护）
- **键盘安全**：第三方键盘风险
- **截屏/录屏**：敏感页面保护
- **剪贴板安全**：敏感数据泄露

【约束】
- 不使用私有 API
- 不触发系统弹窗
- 不影响 App Store 审核
- 不显著增加启动时间（< 100ms）
- 不引入误判影响正常用户

【防御层次】（纵深防御）

## 1. 编译期保护
- 代码混淆策略
- 符号裁剪
- 字符串加密

## 2. 启动期检测
- 环境完整性检查
- 签名校验
- 越狱检测

## 3. 运行期防护
- 关键操作前校验（登录、支付、敏感数据访问）
- 敏感 API 调用前检测
- 低频抽查（成本高，一般不建议）

## 4. 响应策略
- 检测到攻击的处理流程
- 服务端联动
- 上报与分析

【响应策略矩阵】

| 检测项 | 置信度 | 响应方式 | 上报级别 |
|--------|--------|----------|---------|
| ptrace 调试 | 高 | 阻断 + 上报 | 紧急 |
| 越狱环境 | 中 | 降级功能 + 警告 | 普通 |
| 模拟器运行 | 低 | 仅上报 | 普通 |
| dylib 注入 | 高 | 阻断 + 上报 | 紧急 |
| SSL 中间人 | 高 | 阻断请求 + 上报 | 紧急 |

【请输出】

1. **各攻击真实实现路径**（技术原理 + 绕过方式）
2. **当前方案可被绕过点**（单点失效 vs 组合防御）
3. **多策略组合建议**（runtime + compile-time + 服务端）
4. **iOS 版本差异**（不同版本的 API 可用性）
5. **误判与降级策略**（TestFlight / Debug 环境 / 合法 SDK）
6. **实施优先级**（P0 立即实施 / P1 首版迭代 / P2 长期完善）
7. **检测时机与频率**（启动时 / 运行时 / 敏感操作前）
8. **性能影响评估**（每项检测的耗时）
9. **自我保护机制**（防止安全函数本身被 patch）
10. **验证与测试方案**（红队测试 / 自动化回归）

【禁止】
- 玄学检测（无原理依据）
- 只列 API 不讲原理
- 单一检测手段（易被绕过）
- 影响 Debug 开发效率（需要开关控制）

【相关文档】
- 审计时对照：`checklist.md` 安全部分
- 执行时使用：`code_execute_step.md`
- 审核时使用：`review_and_rollback.md`

---
只给方案，不写代码