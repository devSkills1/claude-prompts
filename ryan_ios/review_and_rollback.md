# 代码审查与回滚

> Review / 安全审计 / 回滚

## 【审查输入】
- 关联 Plan 文档：
- 执行步骤编号：
- 变更 diff 或文件列表：
- 测试报告（如有）：

---

## 【审查检查清单】

### P0 阻断项（任一不通过则必须阻断）

- [ ] 是否改变了 public API 签名
- [ ] 是否引入已知崩溃风险
- [ ] 是否使用私有 API
- [ ] 是否可在 5 分钟内回滚
- [ ] 是否通过编译和基础测试

### P1 必须说明（需记录理由，可有条件通过）

- [ ] **是否偏离原 plan 目标？**
  偏离原因：

- [ ] **是否引入 App Store 审核风险？**
  风险点：

- [ ] **是否存在稳定性隐患？**
  验证方式：

- [ ] **是否影响性能指标？**
  影响评估（启动耗时/内存/主线程）：

### P2 建议项（不阻断，但需考虑）

- [ ] 是否应进一步拆分步骤
- [ ] 是否有更优实现方案
- [ ] 是否需要增加单元测试
- [ ] 是否需要更新文档

---

## 【安全审计】

### 参考 checklist.md 进行以下检查：

#### 安全性检查
- [ ] 输入验证是否完备
- [ ] 敏感数据是否加密/脱敏
- [ ] 网络请求是否使用 HTTPS
- [ ] 日志是否过滤敏感信息

#### 性能检查
- [ ] 主线程是否存在文件 I/O
- [ ] 是否有同步锁阻塞主线程
- [ ] 日志是否异步写入

#### 稳定性检查
- [ ] KVO 是否成对移除
- [ ] Notification 是否正确注册/移除
- [ ] Block 是否避免 retain cycle
- [ ] 容器操作是否有越界保护

**详细审计请对照 `checklist.md` 逐项检查**

---

## 【回滚策略】

### 回滚触发条件（满足任一则考虑回滚）

- 崩溃率上升 > 0.1%
- 用户反馈量激增（24h 内 > 平时 3 倍）
- 监控告警触发关键指标
- 发现严重安全漏洞
- App Store 审核被拒

### 回滚方案

**Git 回滚命令：**
```bash
# 方案 1：revert（推荐，保留历史）
git revert <commit_hash>

# 方案 2：reset（谨慎使用，会丢失历史）
git reset --hard <commit_hash>
```

**配置回滚步骤：**
- 配置文件变更：
- 数据库迁移回滚：
- 远程开关关闭：

**预计回滚耗时：** ___ 分钟

### 回滚验证

**验证用例：**
- [ ] 核心功能验证
- [ ] 回归测试通过
- [ ] 崩溃率恢复正常
- [ ] 用户反馈监控

**监控指标：**
- 启动时间：
- 崩溃率：
- 主要业务转化率：

---

## 【审查结论】

**审查人：**
**审查时间：**
**结论：** ☐ 通过  ☐ 有条件通过  ☐ 阻断

**备注：**

**下一步行动：**

---

**只给分析，不改代码**

---

## 【示例（提交审查时可直接引用）】

```
【审查输入】
- 关联 Plan 文档：plan_security.md
- 执行步骤编号：3.1
- 变更 diff 或文件列表：SecurityChecker.m（新增越狱路径检测）
- 测试报告：单元测试通过 + 真机手工验证

【审查检查清单】
- [x] 是否改变 public API：否
- [x] 是否引入崩溃风险：否
- [x] 是否使用私有 API：否
- [x] 是否可在 5 分钟内回滚：是（单文件改动）
- [x] 是否通过编译和基础测试：是

P1 说明：
- 是否偏离原 plan：否
- 是否引入审核风险：否
- 是否存在稳定性隐患：未发现，建议上线后监控
- 是否影响性能指标：微乎其微，预计 <5ms

P2 建议：
- 是否应进一步拆分：否，单一方法改动
- 是否有更优方案：可考虑结果缓存（下个步骤处理）
- 是否需要增加单元测试：已有 SecurityCheckerTests 覆盖
- 是否需要更新文档：是，补充安全检测说明

【安全审计】
- 输入验证：路径列表为常量，符合预期
- 敏感数据加密/脱敏：不涉及
- HTTPS：不涉及
- 日志敏感信息：无新增日志
- 主线程文件 I/O：存在路径检查，耗时 <5ms，可接受
- 同步锁阻塞：无
- 日志异步写入：不涉及
- KVO/Notification/Block 风险：无
- 容器越界保护：for-in 遍历已覆盖

【回滚策略】
- Git 回滚命令：`git revert <commit>`
- 配置/数据回滚：不需要
- 预计回滚耗时：1 分钟

【回滚验证】
- 核心功能验证：登录、支付流程 ✅
- 回归测试：安全检测单元测试 ✅
- 崩溃率监控：发布后 24h 重点关注

【审查结论】
- 审查人：Security Reviewer
- 审查时间：2024-05-08
- 结论：✅ 有条件通过
- 备注：下个步骤增加结果缓存并更新安全说明
- 下一步行动：执行 plan 步骤 3.2、更新文档
```
