# React 代码审查与回滚

> 代码改动的审查流程和回滚策略

---

## 【使用场景】

在以下情况使用此模板：
- 每个步骤执行完成后
- 合并代码到主分支前
- 发现问题需要回滚时
- 定期代码审查时

---

## 【审查输入】

```markdown
【审查信息】
- 关联 Plan 文档：plan_xxx.md
- 执行步骤编号：X.X
- 变更描述：（简述改动）
- 变更文件：（文件列表或 git diff）
- 测试结果：（编译/测试是否通过）
```

---

## 【请输出】

### 1. 审查检查清单

#### P0 阻断项（必须通过）

**代码质量：**
- [ ] 是否改变了 public API
- [ ] 是否引入已知性能问题
- [ ] 是否可在 5 分钟内回滚
- [ ] 是否通过 TypeScript 类型检查
- [ ] 是否通过 ESLint 检查
- [ ] 是否通过单元测试

**功能完整性：**
- [ ] 是否完整实现计划功能
- [ ] 边界情况是否处理
- [ ] 错误处理是否完善
- [ ] 加载状态是否展示

**React 规范：**
- [ ] Hooks 规则是否遵守
- [ ] useEffect 依赖是否正确
- [ ] 是否有 React warning
- [ ] key 是否稳定且唯一

---

#### P1 必须说明

**实现偏离：**
- [ ] 是否偏离原 Plan 目标？
  - 如是：说明原因和新方案合理性

**性能影响：**
- [ ] 是否影响 Core Web Vitals？
  - 如是：Lighthouse 对比数据

**包体积影响：**
- [ ] 是否增加包体积？
  - 如是：增加多少，是否可接受

**浏览器兼容性：**
- [ ] 是否影响目标浏览器支持？
  - 如是：说明影响范围

---

#### P2 建议项

**代码优化：**
- [ ] 是否应使用 React.memo
- [ ] 是否应使用 useMemo/useCallback
- [ ] 是否有重复代码可提取

**测试覆盖：**
- [ ] 是否需要补充单元测试
- [ ] 是否需要 E2E 测试

**无障碍：**
- [ ] 是否符合 WCAG 标准
- [ ] 键盘导航是否正常

---

### 2. 性能审查

**渲染性能：**
- [ ] 使用 React DevTools Profiler 分析
- [ ] 无不必要的重渲染
- [ ] 组件渲染时间 < 16ms（60fps）

**包体积：**
- [ ] 使用 Bundle Analyzer 分析
- [ ] 新增代码体积：XX KB
- [ ] 是否合理

**Web Vitals：**
| 指标 | 优化前 | 优化后 | 变化 |
|------|--------|--------|------|
| LCP | X.Xs | X.Xs | ±X% |
| FID | XXms | XXms | ±X% |
| CLS | X.XX | X.XX | ±X% |

---

### 3. 安全审查

**XSS 防护：**
- [ ] dangerouslySetInnerHTML 使用是否必要
- [ ] 用户输入是否清理
- [ ] URL 参数是否验证

**数据安全：**
- [ ] 敏感数据是否加密
- [ ] Token 是否安全存储
- [ ] API Key 是否暴露

**依赖安全：**
```bash
# 检查依赖漏洞
npm audit
```
- [ ] 无已知漏洞
- [ ] 依赖版本合理

---

### 4. 无障碍审查

**基础检查：**
- [ ] 图片有 alt 文本
- [ ] 表单有 label
- [ ] 按钮有描述性文本
- [ ] 键盘可操作

**工具检查：**
- [ ] axe DevTools 无错误
- [ ] Lighthouse Accessibility 分数 > 90

---

### 5. 回滚策略

#### 回滚方案

**Git 回滚：**
```bash
# 方式 1：Revert commit
git revert <commit_hash>

# 方式 2：Reset 到之前的提交（慎用）
git reset --hard <previous_commit>

# 方式 3：创建回滚分支
git checkout -b rollback/xxx
git revert <commit_hash>
```

**回滚影响评估：**
- 是否影响已发布功能：是/否
- 是否需要清理用户数据：是/否
- 预计回滚耗时：< X 分钟
- 回滚风险：低/中/高

---

#### 回滚验证

回滚后必须验证：
- [ ] 核心功能正常
- [ ] 性能指标正常
- [ ] 无新增报错
- [ ] 回归测试通过

---

### 6. 改进建议

**代码层面：**
1. 建议 1：...
2. 建议 2：...

**性能层面：**
1. 建议 1：...

**测试层面：**
1. 建议 1：...

---

### 7. 审查结论

**审查人：** （姓名/AI Assistant）

**审查时间：** YYYY-MM-DD HH:mm

**结论：**
- ✅ 通过 - 可合并
- ⚠️ 有条件通过 - 需小幅调整后合并
- ❌ 不通过 - 需重大修改

**通过条件（如有条件通过）：**
1. 条件 1：补充单元测试
2. 条件 2：添加 TypeScript 类型

**阻断问题（如不通过）：**
1. 问题 1：存在 XSS 漏洞
   - 严重程度：P0
   - 修复建议：使用 DOMPurify 清理用户输入

**下一步行动：**
1. 修复阻断问题
2. 补充测试
3. 重新提交审查

---

## 【审查示例】

### 示例 1：组件懒加载审查

**输入：**
```
【审查信息】
- 关联 Plan：plan_performance.md
- 步骤：2.1 - 实现组件懒加载
- 变更：修改 src/App.tsx
- 测试：编译通过，Lighthouse 提升 10 分
```

**输出：**
```
## 审查检查清单

### P0 阻断项
✅ 未改变 public API
✅ 无性能问题
✅ 可快速回滚
✅ TypeScript 检查通过
✅ ESLint 无错误
✅ 测试通过

### P1 必须说明
✅ 是否偏离原 Plan？
   否，严格按照 Plan 2.1 实施

✅ 性能影响
   Lighthouse 性能分数：85 → 95
   FCP：2.5s → 2.0s
   影响：正面 ✅

✅ 包体积影响
   初始 Bundle：300KB → 180KB
   影响：减小 40% ✅

### P2 建议项
⚠️ 建议添加错误边界
   - Suspense fallback 可能失败
   - 建议包裹 Error Boundary

## 性能审查
✅ Profiler 分析：无不必要渲染
✅ Bundle 分析：代码分割正确

## 安全审查
✅ 无安全问题

## 无障碍审查
✅ Loading 状态有文本提示

## 回滚策略
- 回滚方式：git revert
- 回滚耗时：< 2 分钟
- 回滚风险：低

## 审查结论
**结论：** ⚠️ 有条件通过

**建议：**
1. 补充 Error Boundary
2. 继续执行下一步（2.2）
```

---

## 【紧急回滚流程】

如发现严重问题需要紧急回滚：

### Step 1：评估影响
- 问题严重程度：P0/P1/P2
- 影响范围：全部用户/部分用户
- 是否需要立即回滚：是/否

### Step 2：执行回滚
```bash
# 1. 创建回滚分支
git checkout -b hotfix/rollback-xxx

# 2. Revert 问题提交
git revert <commit_hash>

# 3. 验证回滚
npm run build
npm run test

# 4. 部署回滚
npm run deploy
```

### Step 3：验证修复
- [ ] 核心功能正常
- [ ] 性能正常
- [ ] 无新增错误

### Step 4：问题复盘
- 问题原因：...
- 如何避免：...
- 改进措施：...

---

## 【总结】

**审查的目的：**
- 确保代码质量
- 及时发现问题
- 降低上线风险
- 保证可回滚性

**原则：**
- 性能为王（Web Vitals）
- 用户体验第一
- 无障碍不可忽视
- 安全永远重要
